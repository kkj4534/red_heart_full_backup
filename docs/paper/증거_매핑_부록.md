# 증거 매핑 부록

본 문서는 예비_시안.md의 모든 핵심 주장을 실제 코드와 매핑한다.

## 시스템 아키텍처 관련

**[ARCH-01] 730M 파라미터 구성**
- 파일: training/unified_training_final.py
- 위치: UnifiedTrainingConfig 클래스 (63-116행)
- 라인 68: `self.model_params = 730_000_000`
- 요지: 730M 파라미터 명시적 선언

**[ARCH-02] 모듈별 파라미터 분배**
- 파일: training/unified_training_final.py
- 위치: UnifiedModel.__init__ (121-174행)
- 요지: 백본 90.6M, 헤드 153M, Neural Analyzers 368M 등 분배

**[ARCH-03] 5단계 워크플로우**
- 파일: main.py
- 위치: RedHeartSystem.analyze_async (704-759행)
- 요지: 입력→백본→헤드→분석기→통합의 5단계 처리

## 데이터 관련

**[DATA-01] Claude API 전처리 10,460개 샘플**
- 파일: claude_api_preprocessing/claude_preprocessed_complete.json
- 검증: `python3 -c "import json; print(len(json.load(open('...')))"` → 10460
- 요지: SCRUPLES 데이터 Claude API 전처리

**[DATA-02] 임베딩 청크 저장**
- 파일: claude_api_preprocessing/embedded/metadata.json
- 위치: 1-96행 전체
- 요지: 11개 청크(각 1000개, 마지막 460개) 분산 저장

**[DATA-03] 데이터 구조**
- 파일: data_loader.py
- 위치: PreprocessedDataLoader._load_data (31-61행)
- 요지: text, emotions, bentham_scores, regret_factor, surd_metrics 포함

## 백본 네트워크

**[BACK-01] Unified Backbone 구조**
- 파일: unified_backbone.py
- 위치: RedHeartUnifiedBackbone.__init__
- 요지: 8층 트랜스포머, 14개 어텐션 헤드, d_model=896

**[BACK-02] 태스크별 라우팅**
- 파일: unified_backbone.py
- 위치: forward 메소드의 task_routing 로직
- 요지: 태스크별 독립 처리와 크로스어텐션

## 헤드 모듈

**[HEAD-01] EmotionHead 구현**
- 파일: unified_heads.py
- 위치: EmotionHead 클래스
- 요지: 38.3M 파라미터, 7개 기본 감정 + 28개 하위 + 112개 뉘앙스

**[HEAD-02] BenthamHead 구현**
- 파일: unified_heads.py
- 위치: BenthamHead 클래스
- 요지: 10차원 윤리 변수 초기 가중치 설정

**[HEAD-03] RegretHead 구현**
- 파일: unified_heads.py
- 위치: RegretHead 클래스
- 요지: 7가지 후회 유형별 점수 계산

**[HEAD-04] SURDHead 구현**
- 파일: unified_heads.py
- 위치: SURDHead 클래스
- 요지: Partial Information Decomposition

## Neural Analyzers

**[NEUR-01] NeuralBenthamCalculator**
- 파일: analyzer_neural_modules.py
- 위치: 159-241행
- 요지: 61M 파라미터, 6층 재가중 레이어

**[NEUR-02] NeuralRegretAnalyzer**
- 파일: analyzer_neural_modules.py
- 위치: 273-325행
- 요지: 68M 파라미터, 7×3=21회 계산

**[NEUR-03] NeuralEmotionAnalyzer**
- 파일: analyzer_neural_modules.py
- 위치: NeuralEmotionAnalyzer 클래스
- 요지: 3단계 위계(개인-타자-공동체)

**[NEUR-04] NeuralSURDAnalyzer**
- 파일: analyzer_neural_modules.py
- 위치: NeuralSURDAnalyzer 클래스
- 요지: 35M 파라미터, 인과 그래프 학습

## Advanced Wrappers

**[WRAP-01] GPU 가속 및 배치 처리**
- 파일: advanced_analyzer_wrappers.py
- 위치: create_advanced_analyzer_wrappers 함수
- 요지: 각 Neural Analyzer를 감싸서 최적화

## EmotionDSP 시스템

**[DSP-01] 주파수 매핑**
- 파일: emotion_dsp_simulator.py
- 위치: EMOTION_FREQUENCIES 상수
- 요지: 7개 감정을 50-350Hz로 매핑

**[DSP-02] ADSR 엔벨로프**
- 파일: emotion_dsp_simulator.py
- 위치: apply_adsr_envelope 메소드
- 요지: Attack-Decay-Sustain-Release 모델링

**[DSP-03] 칼만 필터**
- 파일: emotion_dsp_simulator.py
- 위치: DynamicKalmanFilter 클래스
- 요지: 예측-보정 사이클로 노이즈 제거

## ModuleBridgeCoordinator

**[COORD-01] 메모리 관리 및 OOM 방지**
- 파일: module_bridge_coordinator.py
- 위치: memory_monitor 메소드
- 요지: 85% 임계값에서 모듈 스왑

**[COORD-02] 비동기 처리**
- 파일: module_bridge_coordinator.py
- 위치: integrated_analysis 메소드
- 요지: asyncio로 4개 헤드 병렬 실행

## 학습 시스템

**[TRAIN-01] 학습 설정**
- 파일: training/unified_training_final.py
- 위치: UnifiedTrainingConfig.__init__ (66-115행)
- 라인 74: `self.total_epochs = 50`
- 라인 75-76: `micro_batch_size = 2`, `gradient_accumulation = 32`
- 요지: 50 에폭, 유효 배치 64

**[TRAIN-02] Sweet Spot Detection**
- 파일: training/sweet_spot_detector.py
- 위치: SweetSpotDetector.detect 메소드
- 요지: 검증 손실 3 에폭 연속 증가 시 최적점

**[TRAIN-03] Parameter Crossover**
- 파일: training/parameter_crossover_system.py
- 위치: ParameterCrossoverSystem.crossover 메소드
- 요지: 'selective' 전략으로 레이어별 최고 성능 선별

**[TRAIN-04] Advanced Techniques**
- 파일: training/unified_training_final.py
- 위치: UnifiedTrainingConfig (89-95행)
- 라인 93: `self.label_smoothing = 0.1`
- 라인 94: `self.rdrop_alpha = 1.0`
- 라인 95: `self.ema_decay = 0.999`

## 메인 시스템 통합

**[MAIN-01] 시스템 초기화**
- 파일: main.py
- 위치: RedHeartSystem.initialize (248-313행)
- 요지: 10개 컴포넌트 병렬 초기화, 60초 타임아웃

**[MAIN-02] 모듈 등록**
- 파일: main.py
- 위치: _register_modules_to_coordinator (480-521행)
- 요지: 4개 기본 모듈을 ModuleBridgeCoordinator에 등록

**[MAIN-03] 통합 분석**
- 파일: main.py
- 위치: analyze_with_bridge_coordinator (572-633행)
- 요지: 브릿지 코디네이터를 통한 통합 분석

**[MAIN-04] XAI 설명 생성**
- 파일: main.py
- 위치: _generate_xai_explanation (635-664행)
- 요지: 각 모듈의 기여도와 처리 흐름 추적

**[MAIN-05] 시스템 조화도 평가**
- 파일: main.py
- 위치: _assess_system_harmony (1307-1347행)
- 요지: harmony = 1 - std(confidences)로 계산

## 실행 및 배포

**[RUN-01] 학습 실행 명령**
- 파일: run_learning.sh
- 위치: unified-train 케이스
- 요지: `python3 training/unified_training_final.py`

**[RUN-02] 메모리 최적화**
- 파일: training/oom_handler.py
- 위치: OOMHandler 클래스
- 요지: 동적 배치 크기 조정, 메모리 정리