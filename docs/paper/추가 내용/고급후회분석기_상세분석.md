# Advanced Regret Analyzer 상세 분석

## 🎯 개요
`advanced_regret_analyzer.py`는 Red Heart AI 시스템의 핵심 후회 분석 엔진으로, GPU 가속 신경망, 트랜스포머 모델, MoE 시스템을 통합한 최첨단 후회 분석 및 학습 시스템입니다.

---

## 🏗️ **GPU 가속 아키텍처**

### **1. CUDA 기반 후회 네트워크**
```python
class GPURegretNetwork(nn.Module):
    def __init__(self, input_dim=768, hidden_dim=512):
        # 멀티레이어 후회 예측 네트워크
        self.regret_predictor = nn.Sequential(
            nn.Linear(input_dim, hidden_dim),        # 768 → 512
            nn.ReLU(),
            nn.Dropout(0.2),
            nn.Linear(hidden_dim, hidden_dim // 2),  # 512 → 256
            nn.ReLU(), 
            nn.Dropout(0.1),
            nn.Linear(hidden_dim // 2, 64),          # 256 → 64
            nn.ReLU(),
            nn.Linear(64, 1),                        # 64 → 1 (후회 점수)
            nn.Sigmoid()
        ).to(self.device)
```

**아키텍처 특징**:
- **입력 차원**: 768차원 (BERT 임베딩 호환)
- **은닉층**: 512 → 256 → 64차원으로 점진적 압축
- **출력**: 0-1 범위의 후회 강도 점수
- **정규화**: Dropout(0.2, 0.1)으로 과적합 방지

### **2. 감정 벡터 예측 시스템**
```python
# 감정 벡터 예측 네트워크 (256차원 감정 공간)
self.emotion_predictor = nn.Sequential(
    nn.Linear(input_dim, hidden_dim),     # 768 → 512
    nn.ReLU(),
    nn.Linear(hidden_dim, 256),           # 512 → 256
    nn.Tanh()  # -1~1 범위 감정 벡터
)
```

---

## 🧠 **트랜스포머 통합**

### **KLUE-BERT 기반 후회 패턴 학습**
- **모델**: klue/bert-base (한국어 특화)
- **토크나이저**: KLUE 토크나이저 통합
- **배치 처리**: 동적 배치 크기 (4-128) 조정
- **메모리 최적화**: GPU 8GB 제한 고려한 15% 할당

```python
# 배치 처리 시스템
self.batch_size = 4  
self.batch_timeout = 0.1  # 100ms 타임아웃
self.request_queue = []   # 요청 큐잉
```

---

## 🎭 **MoE 후회 전문가 시스템**

### **다각도 후회 분석**:
```python
from mixture_of_experts import create_regret_moe, MixtureOfExperts

# 후회 분석 전문가 시스템 초기화
self.regret_moe = create_regret_moe(
    input_dim=768,
    output_dim=256, 
    num_experts=4
)
```

**4개 전문가 구성**:
- **전문가 1**: 예상 후회 (Anticipated Regret)
- **전문가 2**: 경험 후회 (Experienced Regret) 
- **전문가 3**: 반사실적 후회 (Counterfactual Regret)
- **전문가 4**: 학습 기반 후회 (Learning-based Regret)

---

## 🔮 **3뷰 시나리오 시스템 통합**

### **시나리오별 후회 예측**:
```python
from three_view_scenario_system import ThreeViewScenarioSystem

self.three_view_system = ThreeViewScenarioSystem(device=self.device)
```

**3가지 관점**:
1. **낙관적 시나리오** (μ + σ): 최선의 결과 가정한 후회
2. **중도적 시나리오** (μ): 평균적 결과에 대한 후회
3. **비관적 시나리오** (μ - σ): 최악의 결과 가정한 후회

**통합 계산**:
- 각 시나리오별 후회 점수 계산
- 확률 가중 평균으로 최종 후회 예측
- 불확실성 기반 위험 조정

---

## ⚡ **성능 최적화**

### **1. 동적 복잡도 평가**
```python
def _evaluate_decision_complexity(self, processed_data) -> int:
    """의사결정 복잡도 평가 (1-5 점수)"""
    complexity_score = 0
    text = processed_data.get('text', '')
    
    # 텍스트 길이, 감정 복잡도, 윤리적 딜레마 정도 평가
    return complexity_score
```

**처리 방식 결정**:
- **복잡도 >= 3**: 전체 베이지안 반사실적 추론 사용
- **복잡도 < 3**: 경량 후회 분석 사용

### **2. 비동기 처리 파이프라인**
```python
async def analyze_regret(self, decision_data, outcome_data=None):
    """비동기 후회 분석 수행"""
    # 전처리 → 복잡도 평가 → 적응형 분석 → 결과 통합
```

### **3. GPU 메모리 관리**
```python
# 동적 GPU 관리자 연동
from dynamic_gpu_manager import get_gpu_manager
self.gpu_manager = get_gpu_manager()

# 안정성을 위한 15% 메모리 할당
self.gpu_memory_fraction = 0.15
```

---

## 📊 **고급 메트릭 시스템**

### **AdvancedRegretMetrics 구조**:
```python
@dataclass
class AdvancedRegretMetrics:
    # 기본 후회 메트릭
    anticipated_regret: float          # 예상 후회
    experienced_regret: float          # 경험 후회  
    regret_intensity: float            # 후회 강도
    regret_duration: float             # 후회 지속시간
    
    # GPU 가속 고급 메트릭
    semantic_regret_score: float       # 의미적 후회 점수
    emotional_regret_vector: List[float] # 감정 후회 벡터
    causal_attribution_scores: Dict[str, float] # 원인 귀속 점수
    counterfactual_utility_delta: float # 반사실적 효용 차이
    
    # 성능 메트릭
    computation_time_ms: float         # 계산 시간
    gpu_memory_usage_mb: float         # GPU 메모리 사용량
    cache_hit_rate: float              # 캐시 적중률
```

---

## 🧮 **베이지안 반사실적 추론**

### **복잡한 의사결정 분석**:
1. **사전 확률 추정**: 의사결정 이전 상황 분석
2. **가능한 결과 시뮬레이션**: 다양한 선택지별 결과 예측
3. **사후 확률 계산**: 실제 결과 관찰 후 확률 업데이트
4. **반사실적 비교**: "만약 다르게 선택했다면?" 분석

```python
async def _perform_complex_regret_analysis(self, processed_data, outcome_data, 
                                         start_time, initial_memory):
    """전체 베이지안 반사실적 추론 수행"""
    # 1. 트랜스포머 기반 의미 분석
    # 2. MoE 전문가 시스템 활용  
    # 3. 3뷰 시나리오 통합
    # 4. 베이지안 추론 적용
```

---

## 🔄 **PhaseController Hook 통합**

### **단계별 성능 추적**:
```python
from phase_controller_hook import PhaseControllerHook, PhaseType

# 후회 분석기 성능 모니터링
self.phase_controller = PhaseControllerHook(
    model_dict=models,  # regret_network, regret_moe 등
    device=self.device
)
```

**추적 메트릭**:
- **Phase별 처리 시간**: 각 분석 단계별 소요 시간
- **모델별 성능**: 네트워크, MoE, 시나리오 시스템 성능
- **메모리 사용 패턴**: GPU/CPU 메모리 최적화 지점
- **배치 효율성**: 배치 크기별 처리 효율

---

## 🚀 **실시간 성능 추적**

### **성능 벤치마킹**:
```python
# 실시간 메트릭 수집
self.performance_metrics = []
self.learning_history = []

def _get_gpu_memory_usage(self):
    """GPU 메모리 사용량 실시간 추적"""
    if torch.cuda.is_available():
        return torch.cuda.memory_allocated() / 1024**2  # MB 단위
    return 0.0
```

### **자동 최적화**:
- **학습률 동적 조정**: 성능에 따른 학습률 자동 조정
- **배치 크기 최적화**: 메모리 상황에 따른 배치 크기 조정
- **캐시 전략 최적화**: 적중률 기반 캐시 정책 조정

---

## 🔬 **고급 기능들**

### **1. 의미적 후회 분석**
- **BERT 임베딩**: 텍스트의 의미적 표현 생성
- **의미적 유사도**: 비슷한 상황에서의 후회 패턴 학습
- **컨텍스트 이해**: 문맥에 따른 후회 강도 조정

### **2. 감정-후회 연결**
- **감정 벡터 예측**: 후회와 연관된 감정 상태 예측
- **감정 추적**: 감정 변화에 따른 후회 패턴 분석
- **치료적 접근**: 감정 조절을 통한 후회 완화 방안

### **3. 원인 귀속 분석**
```python
causal_attribution_scores: Dict[str, float]  # 원인별 기여도
```
- **내적 요인**: 개인 성격, 능력, 의사결정 스타일
- **외적 요인**: 환경, 타인, 예측 불가능한 사건
- **시간적 요인**: 타이밍, 순서, 지연 효과

---

## 💡 **혁신적 특징**

### **1. 적응형 처리**
- 의사결정 복잡도에 따른 동적 분석 방식 선택
- 경량-전체 분석 간 자동 전환

### **2. 실시간 학습**
- 후회 경험을 통한 모델 지속 학습
- 개인별 후회 패턴 맞춤화

### **3. 다차원 통합**
- 감정, 윤리, 시나리오 분석 완전 통합
- MoE를 통한 전문가 지식 융합

### **4. 성능 중심 설계**
- GPU 가속을 통한 실시간 분석
- 메모리 효율적인 배치 처리

---

## 🎯 **실제 활용**

### **real_integrated_training.py에서 사용**:
```python
# 고급 후회 분석기 통합
self.advanced_regret_analyzer = AdvancedRegretAnalyzer()

# 후회 분석 수행
regret_result = await self.advanced_regret_analyzer.analyze_regret(
    decision_data={'text': decision_text, 'context': context},
    outcome_data={'result': actual_outcome}
)
```

### **핵심 워크플로우**:
1. **의사결정 데이터 입력** → 전처리 및 임베딩 생성
2. **복잡도 평가** → 적절한 분석 방법 선택  
3. **MoE 전문가 분석** → 다각도 후회 예측
4. **3뷰 시나리오** → 상황별 후회 시뮬레이션
5. **베이지안 추론** → 확률 기반 최종 후회 계산
6. **성능 추적** → 메트릭 수집 및 최적화

---

## 📈 **기대 효과**

1. **정확한 후회 예측**: 트랜스포머와 MoE를 통한 고정밀 분석
2. **실시간 처리**: GPU 가속으로 즉시 피드백 제공
3. **개인화**: 학습을 통한 개인별 후회 패턴 적응
4. **의사결정 지원**: 후회 최소화 관점에서의 선택 가이드

---

**작성일**: 2025년 8월 11일  
**분석 대상**: advanced_regret_analyzer.py (~3M 파라미터)  
**키워드**: GPU가속후회분석, 트랜스포머학습, MoE전문가시스템, 베이지안반사실적추론